<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>ã‚¦ã‚§ã‚¶ãƒ¼ãƒã‚¹ã‚¿ãƒ¼ï¼šå¤©æ°—ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ </title>
  <style>
    /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    body {
      margin: 0;
      font-family: sans-serif;
    }
    #game-container {
      display: flex;
      height: 100vh;
    }
    /* ã‚°ãƒªãƒƒãƒ‰é ˜åŸŸï¼ˆå›ºå®šUIã¨ã‚»ãƒ«é ˜åŸŸã‚’åˆ†é›¢ï¼‰ */
    #grid-container {
      flex: 1;
      position: relative;
      background-color: #ccc;
    }
    /* å›ºå®šUIï¼ˆãƒ¬ãƒ™ãƒ«æƒ…å ±ãƒ»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼‰ */
    #level-info {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: rgba(255,255,255,0.9);
      padding: 5px 10px;
      border-radius: 5px;
      z-index: 2;
    }
    #controls {
      position: absolute;
      bottom: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
      z-index: 2;
    }
    button {
      padding: 5px 10px;
      cursor: pointer;
    }
    /* ã‚°ãƒªãƒƒãƒ‰ã‚»ãƒ«é ˜åŸŸ */
    #grid-cells {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(6, 1fr);
      gap: 2px;
      height: 100%;
    }
    .grid-cell {
      background-color: #fff;
      border: 1px solid #999;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      user-select: none;
    }
    /* ãƒ‘ãƒ¬ãƒƒãƒˆé ˜åŸŸ */
    #palette {
      width: 150px;
      background-color: #f5f5f5;
      padding: 10px;
      border-left: 2px solid #ccc;
    }
    .palette-button {
      width: 100%;
      font-size: 2em;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .selected {
      border: 2px solid red;
    }
    .activated {
      background-color: yellow;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <!-- ã‚°ãƒªãƒƒãƒ‰ã¨å›ºå®šUIéƒ¨åˆ† -->
    <div id="grid-container">
      <div id="level-info">
        <div id="level-title"></div>
        <div id="level-objective"></div>
        <div id="time-display">Time: 0 sec, Turn: 0</div>
      </div>
      <div id="grid-cells"></div>
      <div id="controls">
        <button id="reset-button">ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="hint-button">ãƒ’ãƒ³ãƒˆ</button>
      </div>
    </div>
    <!-- ãƒ‘ãƒ¬ãƒƒãƒˆé ˜åŸŸ -->
    <div id="palette">
      <button class="palette-button" data-element="sun">â˜€ï¸</button>
      <button class="palette-button" data-element="rain">ğŸŒ§ï¸</button>
      <button class="palette-button" data-element="wind">ğŸŒ¬ï¸</button>
      <button class="palette-button" data-element="snow">â„ï¸</button>
      <button class="palette-button" data-element="thunder">âš¡</button>
      <button class="palette-button" data-element="cloud">â˜ï¸</button>
      <!-- æ–°è¦ç´  -->
      <button class="palette-button" data-element="rainbow">ğŸŒˆ</button>
      <button class="palette-button" data-element="aurora">ğŸŒŒ</button>
      <button class="palette-button" data-element="typhoon">ğŸŒ€</button>
    </div>
  </div>

  <script>
    // å¤©æ°—è¦ç´ ã®å¯¾å¿œè¡¨
    const weatherElements = {
      sun: "â˜€ï¸",
      rain: "ğŸŒ§ï¸",
      wind: "ğŸŒ¬ï¸",
      snow: "â„ï¸",
      thunder: "âš¡",
      cloud: "â˜ï¸",
      rainbow: "ğŸŒˆ",
      aurora: "ğŸŒŒ",
      typhoon: "ğŸŒ€"
    };

    // ãƒ¬ãƒ™ãƒ«è¨­å®šï¼ˆä¾‹ã¨ã—ã¦2ãƒ¬ãƒ™ãƒ«ï¼‰
    const levels = [
      {
        level: 1,
        name: "æœ€åˆã®ä¸€æ­©",
        objective: "1æœ¬ã®æœ¨ã‚’æˆé•·ã•ã›ã‚‹ï¼ˆå¤ªé™½+é›¨ ã¾ãŸã¯ é›ª+ã‚ªãƒ¼ãƒ­ãƒ©ã®çµ„ã¿åˆã‚ã›ï¼‰",
        seedIndexes: [8],
        growthThreshold: 3
      },
      {
        level: 2,
        name: "äºŒæœ¬ç›®ã®æˆé•·",
        objective: "2æœ¬ã®æœ¨ã‚’æˆé•·ã•ã›ã‚‹",
        seedIndexes: [8, 15],
        growthThreshold: 3
      }
    ];
    let currentLevelIndex = 0;

    // ã‚°ãƒªãƒƒãƒ‰è¨­å®š
    const gridSize = 6;
    const gridCellsContainer = document.getElementById("grid-cells");
    let cells = [];

    function createGrid() {
      gridCellsContainer.innerHTML = "";
      cells = [];
      for (let i = 0; i < gridSize * gridSize; i++) {
        const cell = document.createElement("div");
        cell.classList.add("grid-cell");
        cell.dataset.index = i;
        cell.dataset.growth = "0";
        cell.addEventListener("click", onCellClick);
        cell.addEventListener("contextmenu", onCellRightClick);
        // é•·æŠ¼ã—ã§å‰Šé™¤ï¼ˆ800msä»¥ä¸Šãƒ›ãƒ¼ãƒ«ãƒ‰ï¼‰
        let pressTimer;
        cell.addEventListener("mousedown", function(e) {
          pressTimer = window.setTimeout(() => {
            cell.textContent = "";
            cell.dataset.growth = "0";
            delete cell.dataset.timer;
          }, 800);
        });
        cell.addEventListener("mouseup", function(e) {
          clearTimeout(pressTimer);
        });
        cell.addEventListener("mouseout", function(e) {
          clearTimeout(pressTimer);
        });
        gridCellsContainer.appendChild(cell);
        cells.push(cell);
      }
    }

    // ãƒ‘ãƒ¬ãƒƒãƒˆå‡¦ç†
    let selectedElement = null;
    const paletteButtons = document.querySelectorAll(".palette-button");
    paletteButtons.forEach(button => {
      button.addEventListener("click", function() {
        paletteButtons.forEach(btn => btn.classList.remove("selected"));
        selectedElement = button.dataset.element;
        button.classList.add("selected");
      });
    });

    function onCellClick(e) {
      const cell = e.currentTarget;
      if (selectedElement) {
        cell.textContent = weatherElements[selectedElement];
        cell.dataset.growth = "0";
        // æ–°è¦ç´ ã®å ´åˆã€ä½¿ç”¨å¯èƒ½ãªã‚¿ãƒ¼ãƒ³æ•°ã‚’ã‚»ãƒƒãƒˆ
        if (selectedElement === "rainbow") {
          cell.dataset.timer = 5; // 5ã‚¿ãƒ¼ãƒ³æŒç¶š
        } else if (selectedElement === "aurora") {
          cell.dataset.timer = 5;
        } else if (selectedElement === "typhoon") {
          cell.dataset.timer = 2;
        } else {
          delete cell.dataset.timer;
        }
      } else {
        if (cell.textContent !== "") {
          cell.classList.toggle("activated");
        }
      }
    }

    function onCellRightClick(e) {
      e.preventDefault();
      const cell = e.currentTarget;
      cell.textContent = "";
      cell.dataset.growth = "0";
      delete cell.dataset.timer;
    }

    function getNeighborIndexes(index) {
      const neighbors = [];
      const row = Math.floor(index / gridSize);
      const col = index % gridSize;
      for (let dr = -1; dr <= 1; dr++) {
        for (let dc = -1; dc <= 1; dc++) {
          if (dr === 0 && dc === 0) continue;
          const newRow = row + dr;
          const newCol = col + dc;
          if (newRow >= 0 && newRow < gridSize && newCol >= 0 && newCol < gridSize) {
            neighbors.push(newRow * gridSize + newCol);
          }
        }
      }
      return neighbors;
    }

    // ç¨®ã®æˆé•·æ¡ä»¶ï¼šéš£æ¥ã‚»ãƒ«ã«ã€Œâ˜€ï¸ã€ã¨ã€ŒğŸŒ§ï¸ã€ãŒã‚ã‚‹ã‹ã€ã¾ãŸã¯ã€Œâ„ï¸ã€ã¨ã€ŒğŸŒŒã€ãŒã‚ã‚‹ã‹
    // ãªãŠã€éš£æ¥ã‚»ãƒ«ã«è™¹ï¼ˆğŸŒˆï¼‰ãŒã‚ã‚‹å ´åˆã€æˆé•·ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®å¢—åŠ é‡ãŒ2å€ã«ãªã‚Šã¾ã™ã€‚
    function getSeedGrowthIncrement(index) {
      const neighbors = getNeighborIndexes(index);
      let hasSun = false, hasRain = false, hasAurora = false, hasSnow = false;
      let bonus = 1;
      neighbors.forEach(idx => {
        const content = cells[idx].textContent;
        if (content === weatherElements.sun) hasSun = true;
        if (content === weatherElements.rain) hasRain = true;
        if (content === weatherElements.aurora) hasAurora = true;
        if (content === weatherElements.snow) hasSnow = true;
        if (content === weatherElements.rainbow) bonus = 2; // åŠ¹æœå¼·åŒ–
      });
      if ((hasSun && hasRain) || (hasAurora && hasSnow)) {
        return bonus;
      }
      return 0;
    }

    // å°é¢¨ã®åŠ¹æœï¼šå°é¢¨ã‚»ãƒ«ï¼ˆğŸŒ€ï¼‰ã®éš£æ¥ã‚»ãƒ«åŒå£«ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å…¥ã‚Œæ›¿ãˆã‚‹
    function applyTyphoonEffect() {
      cells.forEach((cell, index) => {
        if (cell.textContent === weatherElements.typhoon) {
          const neighbors = getNeighborIndexes(index);
          // å¯¾è±¡ã¯ã€ç¨®ï¼ˆğŸŒ±ï¼‰ã‚„æœ¨ï¼ˆğŸŒ³ï¼‰ä»¥å¤–ã®å¤©æ°—è¦ç´ 
          const validNeighbors = neighbors.filter(idx => {
            const content = cells[idx].textContent;
            return content !== "" && content !== "ğŸŒ±" && content !== "ğŸŒ³";
          });
          if (validNeighbors.length >= 2) {
            const idx1 = validNeighbors[Math.floor(Math.random() * validNeighbors.length)];
            let idx2 = validNeighbors[Math.floor(Math.random() * validNeighbors.length)];
            while (idx1 === idx2 && validNeighbors.length > 1) {
              idx2 = validNeighbors[Math.floor(Math.random() * validNeighbors.length)];
            }
            const temp = cells[idx1].textContent;
            cells[idx1].textContent = cells[idx2].textContent;
            cells[idx2].textContent = temp;
          }
        }
      });
    }

    // æ–°è¦ç´ ã®ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ï¼ˆæ–°è¦ç´ ã¯è¨­å®šã‚¿ãƒ¼ãƒ³çµŒéå¾Œã«è‡ªå‹•æ¶ˆå¤±ï¼‰
    function updateWeatherElementTimers() {
      cells.forEach(cell => {
        const content = cell.textContent;
        if (content === weatherElements.rainbow ||
            content === weatherElements.aurora ||
            content === weatherElements.typhoon) {
          if (cell.dataset.timer) {
            let t = parseInt(cell.dataset.timer);
            t--;
            if (t <= 0) {
              cell.textContent = "";
              delete cell.dataset.timer;
            } else {
              cell.dataset.timer = t;
            }
          }
        }
      });
    }

    let turn = 0;
    const timeDisplay = document.getElementById("time-display");
    const turnInterval = 1000; // 1ç§’ã”ã¨
    let simulationTimer = null;

    function checkLevelCompletion() {
      const currentLevel = levels[currentLevelIndex];
      let completeCount = 0;
      currentLevel.seedIndexes.forEach(idx => {
        if (cells[idx].textContent === "ğŸŒ³") {
          completeCount++;
        }
      });
      if (completeCount === currentLevel.seedIndexes.length) {
        levelComplete();
      }
    }

    function startSimulationTimer() {
      simulationTimer = setInterval(function() {
        turn++;
        timeDisplay.textContent = 'Time: ' + turn + ' sec, Turn: ' + turn;
        const currentLevel = levels[currentLevelIndex];
        // å„ç¨®ã®æˆé•·å‡¦ç†ï¼ˆç¨®ãŒæ¡ä»¶ã‚’æº€ãŸã™ã¨æˆé•·ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŒé€²ã‚€ï¼‰
        cells.forEach((cell, index) => {
          if (cell.textContent === "ğŸŒ±") {
            const increment = getSeedGrowthIncrement(index);
            if (increment > 0) {
              let growth = parseInt(cell.dataset.growth) || 0;
              growth += increment;
              cell.dataset.growth = growth;
              if (growth >= currentLevel.growthThreshold) {
                cell.textContent = "ğŸŒ³";
                cell.dataset.growth = "0";
              }
            } else {
              cell.dataset.growth = "0";
            }
          }
        });
        // æ–°è¦ç´ ã®ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
        updateWeatherElementTimers();
        // å°é¢¨ã®åŠ¹æœã‚’é©ç”¨
        applyTyphoonEffect();
        // ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢åˆ¤å®š
        checkLevelCompletion();
      }, turnInterval);
    }

    function levelComplete() {
      clearInterval(simulationTimer);
      alert("ãƒ¬ãƒ™ãƒ«" + levels[currentLevelIndex].level + "ã‚¯ãƒªã‚¢ï¼");
      if (currentLevelIndex < levels.length - 1) {
        currentLevelIndex++;
        setTimeout(() => loadLevel(currentLevelIndex), 1000);
      } else {
        alert("å…¨ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼");
      }
    }

    function loadLevel(levelIndex) {
      turn = 0;
      timeDisplay.textContent = 'Time: ' + turn + ' sec, Turn: ' + turn;
      const currentLevel = levels[levelIndex];
      document.getElementById("level-title").textContent =
        "ãƒ¬ãƒ™ãƒ«" + currentLevel.level + "ï¼šã€Œ" + currentLevel.name + "ã€";
      document.getElementById("level-objective").textContent =
        "ç›®æ¨™: " + currentLevel.objective;
      createGrid();
      currentLevel.seedIndexes.forEach(idx => {
        cells[idx].textContent = "ğŸŒ±";
        cells[idx].dataset.growth = "0";
      });
      startSimulationTimer();
    }

    document.getElementById("reset-button").addEventListener("click", function() {
      clearInterval(simulationTimer);
      loadLevel(currentLevelIndex);
    });

    document.getElementById("hint-button").addEventListener("click", function() {
      alert("ãƒ’ãƒ³ãƒˆ: ç¨®ã®éš£ã«â˜€ï¸ã¨ğŸŒ§ï¸ã€ã¾ãŸã¯â„ï¸ã¨ğŸŒŒã‚’é…ç½®ã™ã‚‹ã¨æˆé•·ã—ã¾ã™ã€‚\nè™¹ï¼ˆğŸŒˆï¼‰ã§åŠ¹æœã‚¢ãƒƒãƒ—ã€å°é¢¨ï¼ˆğŸŒ€ï¼‰ã§è¦ç´ ãŒãƒ©ãƒ³ãƒ€ãƒ ã«ç§»å‹•ã—ã¾ã™ã€‚");
    });

    loadLevel(currentLevelIndex);
  </script>
</body>
</html>
