<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>ã‚¦ã‚§ã‚¶ãƒ¼ãƒã‚¹ã‚¿ãƒ¼ï¼šå¤©æ°—ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ  - ãƒ¬ãƒ™ãƒ«è¨­å®šç‰ˆ</title>
  <style>
    /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    body { margin: 0; font-family: sans-serif; }
    #game-container { display: flex; height: 100vh; }
    /* ã‚°ãƒªãƒƒãƒ‰é ˜åŸŸ */
    #grid-container { flex: 1; position: relative; background-color: #ccc; }
    #grid-cells { display: grid; grid-template-columns: repeat(6, 1fr); grid-template-rows: repeat(6, 1fr); gap: 2px; height: 100%; }
    .grid-cell {
      background-color: #fff; border: 1px solid #999;
      display: flex; align-items: center; justify-content: center;
      font-size: 2em; user-select: none;
    }
    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«é ˜åŸŸ */
    #controls { position: absolute; bottom: 10px; right: 10px; display: flex; gap: 10px; z-index: 2; }
    button { padding: 5px 10px; cursor: pointer; }
    /* ãƒ‘ãƒ¬ãƒƒãƒˆé ˜åŸŸ */
    #palette {
      width: 150px; background-color: #f5f5f5; padding: 10px;
      border-left: 2px solid #ccc; display: flex; flex-direction: column; align-items: center;
    }
    /* ãƒ¬ãƒ™ãƒ«æƒ…å ±ã‚’ãƒ‘ãƒ¬ãƒƒãƒˆå†…ã«è¡¨ç¤º */
    #level-info {
      width: 100%; background-color: rgba(255,255,255,0.9);
      padding: 5px; margin-bottom: 10px; border-radius: 5px;
      text-align: center; font-size: 0.9em;
    }
    .palette-button {
      width: 100%; font-size: 2em; margin-bottom: 10px; cursor: pointer;
    }
    .selected { border: 2px solid red; }
    .activated { background-color: yellow; }
  </style>
</head>
<body>
  <div id="game-container">
    <!-- ã‚°ãƒªãƒƒãƒ‰é ˜åŸŸ -->
    <div id="grid-container">
      <div id="grid-cells"></div>
      <div id="controls">
        <button id="reset-button">ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="hint-button">ãƒ’ãƒ³ãƒˆ</button>
      </div>
    </div>
    <!-- ãƒ‘ãƒ¬ãƒƒãƒˆé ˜åŸŸï¼ˆå³å´ï¼‰ -->
    <div id="palette">
      <div id="level-info">
        <div id="level-title"></div>
        <div id="level-objective"></div>
        <div id="allowed-elements"></div>
        <div id="time-display">Time: 0 sec, Turn: 0</div>
      </div>
      <!-- å¤©æ°—è¦ç´ ãƒ‘ãƒ¬ãƒƒãƒˆ -->
      <button class="palette-button" data-element="sun">â˜€ï¸</button>
      <button class="palette-button" data-element="rain">ğŸŒ§ï¸</button>
      <button class="palette-button" data-element="wind">ğŸŒ¬ï¸</button>
      <button class="palette-button" data-element="snow">â„ï¸</button>
      <button class="palette-button" data-element="thunder">âš¡</button>
      <button class="palette-button" data-element="cloud">â˜ï¸</button>
      <button class="palette-button" data-element="rainbow">ğŸŒˆ</button>
      <button class="palette-button" data-element="aurora">ğŸŒŒ</button>
      <button class="palette-button" data-element="typhoon">ğŸŒ€</button>
    </div>
  </div>

  <script>
    // å¤©æ°—è¦ç´ ã®å¯¾å¿œè¡¨
    const weatherElements = {
      sun: "â˜€ï¸", rain: "ğŸŒ§ï¸", wind: "ğŸŒ¬ï¸", snow: "â„ï¸",
      thunder: "âš¡", cloud: "â˜ï¸", rainbow: "ğŸŒˆ", aurora: "ğŸŒŒ", typhoon: "ğŸŒ€"
    };

    // ãƒ¬ãƒ™ãƒ«è¨­å®šï¼ˆãƒ¬ãƒ™ãƒ«1ï½10ï¼‰
    const levels = [
      {
        level: 1,
        name: "æœ€åˆã®ä¸€æ­©",
        objective: "1æœ¬ã®æœ¨ã‚’æˆé•·ã•ã›ã‚‹",
        allowedElements: ["sun", "rain"],
        initialState: {8: "ğŸŒ±"},
        growthThreshold: 3,
        completionCheck: () => cells[8].textContent === "ğŸŒ³"
      },
      // ãƒ¬ãƒ™ãƒ«2ï½10ã¯å‰å›ã¨åŒæ§˜ï¼ˆçœç•¥ï¼‰
      {
        level: 2,
        name: "æ©‹æ¸¡ã—",
        objective: "å·ã‚’æ¸¡ã‚‹ã‚ˆã†ã«ã™ã‚‹",
        allowedElements: ["snow"],
        initialState: {12: "ğŸ˜€", 15: "ğŸŒŠ", 20: "ğŸ"},
        completionCheck: () => cells[15].textContent === "ğŸŒ‰"
      },
      {
        level: 3,
        name: "é¢¨ã®é“",
        objective: "é›²ã‚’ç‰¹å®šã®ä½ç½®ã«ç§»å‹•ã•ã›ã‚‹",
        allowedElements: ["wind"],
        initialState: {10: "â˜ï¸"},
        completionCheck: () => cells[25].textContent === "â˜ï¸"
      },
      {
        level: 4,
        name: "ç¯ã‚Šã‚’ã¤ã‘ã¦",
        objective: "ç¯å°ã®æ˜ã‹ã‚Šã‚’ç¯ã™",
        allowedElements: ["cloud", "wind", "thunder"],
        initialState: {5: "ğŸ®", 22: "â˜ï¸"},
        completionCheck: () => cells[5].textContent === "ğŸ’¡"
      },
      {
        level: 5,
        name: "å†¬ã‹ã‚‰æ˜¥ã¸",
        objective: "å‡ã£ãŸæ¹–ã‚’æº¶ã‹ã—ã€æ¤ç‰©ã‚’æˆé•·ã•ã›ã‚‹",
        allowedElements: ["sun", "rain"],
        initialState: {14: "ğŸ§Š", 15: "ğŸŒ±"},
        completionCheck: () => cells[14].textContent === "ğŸ’§" || cells[15].textContent === "ğŸŒ³"
      },
      {
        level: 6,
        name: "åµã‚’èµ·ã“ã›",
        objective: "ç‰¹å®šã®å ´æ‰€ã«é›·é›¨ã‚’ç™ºç”Ÿã•ã›ã‚‹",
        allowedElements: ["sun", "water", "wind"],
        initialState: {22: "ğŸ’§", 23: ""},
        completionCheck: () => cells[23].textContent === "â›ˆï¸"
      },
      {
        level: 7,
        name: "å­£ç¯€ã®ã‚µã‚¤ã‚¯ãƒ«",
        objective: "4ã¤ã®ã‚¨ãƒªã‚¢ã«ç•°ãªã‚‹å­£ç¯€ã‚’ä½œã‚‹ï¼ˆå†¬ã€æ˜¥ã€å¤ã€ç§‹ï¼‰",
        allowedElements: ["all"],
        initialState: {1: "", 10: "", 20: "", 30: ""},
        completionCheck: () =>
          cells[1].textContent === "â„ï¸" &&
          cells[10].textContent === "ğŸŒ¸" &&
          cells[20].textContent === "â˜€ï¸" &&
          cells[30].textContent === "ğŸ‚"
      },
      {
        level: 8,
        name: "é›»åŠ›ä¾›çµ¦",
        objective: "3ã¤ã®è£…ç½®ã«é›»åŠ›ã‚’ä¾›çµ¦ã™ã‚‹",
        allowedElements: ["cloud", "wind", "thunder"],
        initialState: {3: "ğŸ”Œ", 18: "ğŸ”Œ", 33: "ğŸ”Œ"},
        completionCheck: () =>
          cells[3].textContent === "ğŸ’¡" &&
          cells[18].textContent === "ğŸ’¡" &&
          cells[33].textContent === "ğŸ’¡"
      },
      {
        level: 9,
        name: "ç”Ÿå‘½ã®å¾ªç’°",
        objective: "æ¤ç‰©â†’å‹•ç‰©â†’åœŸå£Œâ†’æ¤ç‰©ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’å®Œäº†ã•ã›ã‚‹",
        allowedElements: ["sun", "rain", "wind"],
        initialState: {8: "ğŸŒ±"},
        completionCheck: () => cells[8].textContent === "ğŸ”„"
      },
      {
        level: 10,
        name: "æ°—è±¡äºˆå ±å£«",
        objective: "æŒ‡å®šã•ã‚ŒãŸé †åºã§å¤©æ°—ç¾è±¡ã‚’ç™ºç”Ÿã•ã›ã‚‹ï¼ˆæ™´ã‚Œâ†’é›¨â†’é›·â†’é›ªï¼‰",
        allowedElements: ["all"],
        initialState: {12: ""},
        completionCheck: () => cells[12].textContent === "â˜€ï¸ğŸŒ§ï¸âš¡â„ï¸"
      }
    ];
    let currentLevelIndex = 0;

    // ã‚°ãƒªãƒƒãƒ‰è¨­å®š
    const gridSize = 6;
    const gridCellsContainer = document.getElementById("grid-cells");
    let cells = [];

    function createGrid() {
      gridCellsContainer.innerHTML = "";
      cells = [];
      for (let i = 0; i < gridSize * gridSize; i++) {
        const cell = document.createElement("div");
        cell.classList.add("grid-cell");
        cell.dataset.index = i;
        cell.dataset.growth = "0";
        cell.addEventListener("click", onCellClick);
        cell.addEventListener("contextmenu", onCellRightClick);
        let pressTimer;
        cell.addEventListener("mousedown", function(e) {
          pressTimer = window.setTimeout(() => {
            cell.textContent = "";
            cell.dataset.growth = "0";
            delete cell.dataset.timer;
          }, 800);
        });
        cell.addEventListener("mouseup", function(e) { clearTimeout(pressTimer); });
        cell.addEventListener("mouseout", function(e) { clearTimeout(pressTimer); });
        gridCellsContainer.appendChild(cell);
        cells.push(cell);
      }
    }

    // ãƒ‘ãƒ¬ãƒƒãƒˆå‡¦ç†
    let selectedElement = null;
    const paletteButtons = document.querySelectorAll(".palette-button");
    paletteButtons.forEach(button => {
      button.addEventListener("click", function() {
        paletteButtons.forEach(btn => btn.classList.remove("selected"));
        selectedElement = button.dataset.element;
        button.classList.add("selected");
      });
    });

    function onCellClick(e) {
      const cell = e.currentTarget;
      if (selectedElement) {
        cell.textContent = weatherElements[selectedElement];
        cell.dataset.growth = "0";
        if (["rainbow", "aurora", "typhoon"].includes(selectedElement)) {
          cell.dataset.timer = (selectedElement === "typhoon") ? 2 : 5;
        } else { delete cell.dataset.timer; }
      } else {
        if (cell.textContent !== "") {
          cell.classList.toggle("activated");
        }
      }
    }

    function onCellRightClick(e) {
      e.preventDefault();
      const cell = e.currentTarget;
      cell.textContent = "";
      cell.dataset.growth = "0";
      delete cell.dataset.timer;
    }

    function getNeighborIndexes(index) {
      const neighbors = [];
      const row = Math.floor(index / gridSize);
      const col = index % gridSize;
      for (let dr = -1; dr <= 1; dr++) {
        for (let dc = -1; dc <= 1; dc++) {
          if (dr === 0 && dc === 0) continue;
          const newRow = row + dr;
          const newCol = col + dc;
          if (newRow >= 0 && newRow < gridSize && newCol >= 0 && newCol < gridSize) {
            neighbors.push(newRow * gridSize + newCol);
          }
        }
      }
      return neighbors;
    }

    // ä¿®æ­£æ¸ˆã¿ï¼šç¨®ã®æˆé•·ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ¬ãƒ™ãƒ«1ãƒ»9ï¼‰
    function simulateSeedGrowth(index) {
      const cell = cells[index];
      const neighbors = getNeighborIndexes(index);
      let hasSun = false;
      let hasRain = false;
      let bonus = 1;
      for (let n of neighbors) {
        if (cells[n].textContent === weatherElements.sun) hasSun = true;
        if (cells[n].textContent === weatherElements.rain) hasRain = true;
        if (cells[n].textContent === weatherElements.rainbow) bonus = 2;
      }
      if (hasSun && hasRain) {
        let growth = Number(cell.dataset.growth) || 0;
        growth += bonus;
        cell.dataset.growth = growth.toString();
        if (growth >= levels[currentLevelIndex].growthThreshold) {
          cell.textContent = "ğŸŒ³";
          cell.dataset.growth = "0";
        }
      } else {
        // æ¡ä»¶ãŒç¶™ç¶šã—ã¦æº€ãŸã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
        cell.dataset.growth = "0";
      }
    }

    // å°é¢¨ã®åŠ¹æœï¼šå°é¢¨ã‚»ãƒ«ï¼ˆğŸŒ€ï¼‰ã®éš£æ¥ã‚»ãƒ«åŒå£«ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å…¥ã‚Œæ›¿ãˆã‚‹
    function applyTyphoonEffect() {
      cells.forEach((cell, index) => {
        if (cell.textContent === weatherElements.typhoon) {
          const neighbors = getNeighborIndexes(index);
          const validNeighbors = neighbors.filter(idx => {
            const content = cells[idx].textContent;
            return content !== "" && content !== "ğŸŒ±" && content !== "ğŸŒ³";
          });
          if (validNeighbors.length >= 2) {
            const idx1 = validNeighbors[Math.floor(Math.random() * validNeighbors.length)];
            let idx2 = validNeighbors[Math.floor(Math.random() * validNeighbors.length)];
            while (idx1 === idx2 && validNeighbors.length > 1) {
              idx2 = validNeighbors[Math.floor(Math.random() * validNeighbors.length)];
            }
            const temp = cells[idx1].textContent;
            cells[idx1].textContent = cells[idx2].textContent;
            cells[idx2].textContent = temp;
          }
        }
      });
    }

    // æ–°è¦ç´ ã®ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ï¼ˆæŒç¶šã‚¿ãƒ¼ãƒ³çµŒéå¾Œã«è‡ªå‹•æ¶ˆå¤±ï¼‰
    function updateWeatherElementTimers() {
      cells.forEach(cell => {
        if (["rainbow", "aurora", "typhoon"].includes(cell.textContent) && cell.dataset.timer) {
          let t = parseInt(cell.dataset.timer);
          t--;
          if (t <= 0) { cell.textContent = ""; delete cell.dataset.timer; }
          else { cell.dataset.timer = t.toString(); }
        }
      });
    }

    let turn = 0;
    const timeDisplay = document.getElementById("time-display");
    const turnInterval = 1000; // 1ç§’ã”ã¨
    let simulationTimer = null;

    function checkLevelCompletion(currentLevel) {
      return currentLevel.completionCheck();
    }

    function startSimulationTimer() {
      simulationTimer = setInterval(function() {
        turn++;
        timeDisplay.textContent = 'Time: ' + turn + ' sec, Turn: ' + turn;
        const currentLevel = levels[currentLevelIndex];
        cells.forEach((cell, index) => {
          if (cell.textContent === "ğŸŒ±") {
            simulateSeedGrowth(index);
          }
        });
        updateWeatherElementTimers();
        simulateEffects(currentLevel);
        if (checkLevelCompletion(currentLevel)) {
          levelComplete();
        }
      }, turnInterval);
    }

    // å„ãƒ¬ãƒ™ãƒ«å›ºæœ‰ã®è‡ªå‹•åŠ¹æœã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    function simulateEffects(currentLevel) {
      if (currentLevel.level === 2) {
        if (cells[15].textContent === "ğŸŒŠ" &&
            getNeighborIndexes(15).some(idx => cells[idx].textContent === weatherElements.snow)) {
          cells[15].textContent = "ğŸŒ‰";
        }
      }
      if (currentLevel.level === 3) {
        const cloudIndex = cells.findIndex(cell => cell.textContent === "â˜ï¸");
        if (cloudIndex !== -1 && cloudIndex !== 25 &&
            getNeighborIndexes(cloudIndex).some(idx => cells[idx].textContent === weatherElements.wind) &&
            cells[25].textContent === "") {
          cells[25].textContent = "â˜ï¸";
          cells[cloudIndex].textContent = "";
        }
      }
      if (currentLevel.level === 4) {
        if (cells[5].textContent === "ğŸ®" &&
            getNeighborIndexes(5).some(idx => cells[idx].textContent === weatherElements.thunder)) {
          cells[5].textContent = "ğŸ’¡";
        }
      }
      if (currentLevel.level === 5) {
        if (cells[14].textContent === "ğŸ§Š" &&
            getNeighborIndexes(14).some(idx => cells[idx].textContent === weatherElements.sun) &&
            getNeighborIndexes(14).some(idx => cells[idx].textContent === weatherElements.rain)) {
          cells[14].textContent = "ğŸ’§";
          if (cells[15].textContent === "ğŸŒ±") {
            cells[15].textContent = "ğŸŒ³";
          }
        }
      }
      if (currentLevel.level === 6) {
        if (cells[22].textContent === "ğŸ’§" &&
            cells.some(cell => cell.textContent === weatherElements.sun) &&
            getNeighborIndexes(22).some(idx => cells[idx].textContent === weatherElements.wind)) {
          cells[23].textContent = "â›ˆï¸";
        }
      }
      if (currentLevel.level === 8) {
        [3, 18, 33].forEach(idx => {
          if (cells[idx].textContent === "ğŸ”Œ" &&
              getNeighborIndexes(idx).some(i => cells[i].textContent === weatherElements.thunder)) {
            cells[idx].textContent = "ğŸ’¡";
          }
        });
      }
      if (currentLevel.level === 9) {
        if (cells[8].textContent === "ğŸŒ³") {
          cells[8].textContent = "ğŸ”„";
        }
      }
      // ãƒ¬ãƒ™ãƒ«10ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œã«ã‚ˆã‚‹é”æˆã‚’æƒ³å®š
    }

    function levelComplete() {
      clearInterval(simulationTimer);
      alert("ãƒ¬ãƒ™ãƒ«" + levels[currentLevelIndex].level + " ã‚¯ãƒªã‚¢ï¼");
      if (currentLevelIndex < levels.length - 1) {
        currentLevelIndex++;
        setTimeout(() => loadLevel(currentLevelIndex), 1000);
      } else {
        alert("å…¨ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼");
      }
    }

    function loadLevel(levelIndex) {
      turn = 0;
      timeDisplay.textContent = 'Time: ' + turn + ' sec, Turn: ' + turn;
      const currentLevel = levels[levelIndex];
      document.getElementById("level-title").textContent =
        "ãƒ¬ãƒ™ãƒ«" + currentLevel.level + "ï¼šã€Œ" + currentLevel.name + "ã€";
      document.getElementById("level-objective").textContent =
        "ç›®æ¨™: " + currentLevel.objective;
      document.getElementById("allowed-elements").textContent =
        "ä½¿ç”¨å¯èƒ½: " + currentLevel.allowedElements.join(" ");
      createGrid();
      for (const key in currentLevel.initialState) {
        const idx = parseInt(key);
        cells[idx].textContent = currentLevel.initialState[key];
      }
      startSimulationTimer();
    }

    document.getElementById("reset-button").addEventListener("click", function() {
      clearInterval(simulationTimer);
      loadLevel(currentLevelIndex);
    });
    document.getElementById("hint-button").addEventListener("click", function() {
      alert("ãƒ’ãƒ³ãƒˆ:\nãƒ»ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¯ãƒ¬ãƒ™ãƒ«ã”ã¨ã«ç•°ãªã‚Šã¾ã™ã€‚\nãƒ»æŒ‡å®šã‚»ãƒ«ã‚„ã‚¨ãƒªã‚¢ã«å¿…è¦ãªçŠ¶æ…‹ã«ãªã‚‹ã‚ˆã†ã€å¤©æ°—è¦ç´ ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚\nï¼ˆä¾‹ï¼šãƒ¬ãƒ™ãƒ«1ã¯ç¨®ã®éš£ã«â˜€ï¸ã¨ğŸŒ§ï¸ã‚’é…ç½®ã™ã‚‹ã¨æˆé•·ã—ã¾ã™ï¼‰");
    });

    loadLevel(currentLevelIndex);
  </script>
</body>
</html>
